<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>ASCII table manager</title>
    <style>
      body {
        font-family: "Courier New", Courier, monospace;
        margin: 20px;
      }
      input[type="number"],
      input[type="checkbox"],
      button,
      select,
      textarea {
        font-family: "Courier New", Courier, monospace;
        font-size: 14px;
      }
      input[type="number"] {
        width: 60px;
        margin-right: 10px;
      }
      label {
        margin-right: 15px;
      }
      table {
        border-collapse: collapse;
        margin-top: 20px;
        font-family: "Courier New", Courier, monospace;
      }
      table td {
        border: 1px solid #ccc;
        padding: 5px;
        min-width: 20px;
      }
      textarea {
        width: 100%;
        height: 150px;
        margin-top: 20px;
        white-space: pre;
      }
    </style>
  </head>
  <body>
    <h1>ASCII table manager</h1>
    <p>
      Créate/generate or copy-paste an existing ASCII table to edit it easily
    </p>
    <label>Lines: <input type="number" id="rows" min="1" value="3" /></label>
    <label>Columns: <input type="number" id="cols" min="1" value="3" /></label>
    &nbsp;&nbsp;&nbsp;
    <label
      ><input type="checkbox" id="sepAll" checked /> Separate each line</label
    >
    &nbsp;&nbsp;&nbsp;
    <label
      >Font:
      <select id="fontSelect">
        <option value="Consolas, monospace" selected>Consolas</option>
        <option value="'Courier New', Courier, monospace">Courier New</option>
        <option value="'Lucida Console', Monaco, monospace">
          Lucida Console
        </option>
        <option value="Monaco, monospace">Monaco</option>
        <option value="Menlo, monospace">Menlo</option>
        <option value="'DejaVu Sans Mono', monospace">DejaVu Sans Mono</option>
        <option value="'Source Code Pro', monospace">Source Code Pro</option>
        <option value="'Fira Code', monospace">Fira Code</option>
        <option value="'Roboto Mono', monospace">Roboto Mono</option>
      </select>
    </label>

    <div id="table-container"></div>
    <textarea
      id="ascii-output"
      placeholder="Le tableau ASCII apparaît ici..."
    ></textarea>
    <!-- JSON export/import area -->
    <textarea
      id="json-output"
      placeholder="Le tableau JSON apparaît ici..."
    ></textarea>

    <script>
      // Calcule la largeur d'affichage en monospace en tenant compte des emojis
      const emojiRegex = /\p{Extended_Pictographic}/u;
      function stringWidth(str) {
        return [...str].reduce((w, ch) => w + (emojiRegex.test(ch) ? 2 : 1), 0);
      }

      const rowsInput = document.getElementById("rows");
      const colsInput = document.getElementById("cols");
      const sepAllCheckbox = document.getElementById("sepAll");
      const fontSelect = document.getElementById("fontSelect");
      const container = document.getElementById("table-container");
      const asciiOutput = document.getElementById("ascii-output");
      const jsonOutput = document.getElementById("json-output");

      rowsInput.addEventListener("input", generateTable);
      colsInput.addEventListener("input", generateTable);
      sepAllCheckbox.addEventListener("change", updateAscii);
      asciiOutput.addEventListener("input", importAscii);
      fontSelect.addEventListener("change", () => {
        container
          .querySelectorAll("table, textarea")
          .forEach((el) => (el.style.fontFamily = fontSelect.value));
        updateAscii();
      });
      jsonOutput.addEventListener("input", importJSON);

      function generateTable() {
        const oldTable = container.querySelector("table");
        let oldData = [];
        if (oldTable) {
          oldData = Array.from(oldTable.rows).map((tr) =>
            Array.from(tr.cells).map((td) => td.textContent.trim())
          );
        }
        const rows = Math.max(1, parseInt(rowsInput.value) || 1);
        const cols = Math.max(1, parseInt(colsInput.value) || 1);
        container.innerHTML = "";
        const table = document.createElement("table");
        table.style.fontFamily = fontSelect.value;
        for (let i = 0; i < rows; i++) {
          const tr = document.createElement("tr");
          for (let j = 0; j < cols; j++) {
            const td = document.createElement("td");
            td.contentEditable = true;
            td.addEventListener("input", updateAscii);
            if (oldData[i] && oldData[i][j] !== undefined) {
              td.textContent = oldData[i][j];
            }
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
        container.appendChild(table);
        asciiOutput.style.fontFamily = fontSelect.value;
        updateAscii();
      }

      function updateAscii() {
        const table = container.querySelector("table");
        if (!table) return;
        const data = Array.from(table.rows).map((tr) =>
          Array.from(tr.cells).map((td) => td.textContent.trim())
        );
        const colWidths = data[0].map((_, ci) => {
          let max = 0;
          data.forEach((r) => {
            const w = stringWidth(r[ci]);
            if (w > max) max = w;
          });
          return max + 2;
        });
        const makeBorder = () =>
          "+" + colWidths.map((w) => "-".repeat(w)).join("+") + "+\n";
        const makeRow = (row) =>
          "|" +
          row
            .map((cell, j) => {
              const cellW = stringWidth(cell);
              return " " + cell + " ".repeat(colWidths[j] - cellW - 1);
            })
            .join("|") +
          "|\n";

        let ascii = "";
        const topBorder = makeBorder();
        ascii += topBorder;
        ascii += makeRow(data[0]);
        ascii += topBorder;
        if (sepAllCheckbox.checked) {
          for (let i = 1; i < data.length; i++) {
            ascii += makeRow(data[i]);
            ascii += topBorder;
          }
        } else {
          for (let i = 1; i < data.length; i++) {
            ascii += makeRow(data[i]);
          }
          ascii += topBorder;
        }
        asciiOutput.value = ascii;
        updateJSON(data);
      }

      function updateJSON(data) {
        jsonOutput.value = JSON.stringify(data);
      }

      function importAscii() {
        const text = asciiOutput.value.trim();
        const lines = text.split("\n").filter((l) => l);
        if (!lines.length) return;
        const borderLines = lines.filter((l) => /^\+[\-+]+\+$/.test(l));
        const rowLines = lines.filter((l) => /^\|.*\|$/.test(l));
        if (!borderLines.length || !rowLines.length) return;
        const cols = borderLines[0].slice(1, -1).split("+").length;
        const data = rowLines.map((l) =>
          l
            .slice(1, -1)
            .split("|")
            .map((cell) => cell.trim())
        );
        rowsInput.value = data.length;
        colsInput.value = cols;
        sepAllCheckbox.checked = borderLines.length > data.length + 1;
        generateTable();
        const table = container.querySelector("table");
        data.forEach((row, i) =>
          row.forEach((cell, j) => {
            if (table.rows[i] && table.rows[i].cells[j])
              table.rows[i].cells[j].textContent = cell;
          })
        );
        updateAscii();
      }

      function importJSON() {
        try {
          const data = JSON.parse(jsonOutput.value);
          if (Array.isArray(data) && data.every((r) => Array.isArray(r))) {
            rowsInput.value = data.length;
            colsInput.value = data[0].length;
            generateTable();
            const table = container.querySelector("table");
            data.forEach((row, i) =>
              row.forEach((cell, j) => {
                if (table.rows[i] && table.rows[i].cells[j])
                  table.rows[i].cells[j].textContent = cell;
              })
            );
            updateAscii();
          }
        } catch (e) {
          // Invalid JSON, ignore
        }
      }

      // Initialisation
      generateTable();
    </script>
  </body>
</html>
