<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>ASCII table manager</title>
    <style>
      body {
        font-family: "Courier New", Courier, monospace;
        margin: 20px;
      }
      input[type="number"],
      input[type="checkbox"],
      button,
      select,
      textarea {
        font-family: "Courier New", Courier, monospace;
        font-size: 14px;
      }
      input[type="number"] {
        width: 60px;
        margin-right: 10px;
      }
      label {
        margin-right: 15px;
      }
      table {
        border-collapse: collapse;
        margin-top: 20px;
        font-family: "Courier New", Courier, monospace;
      }
      table td {
        border: 1px solid #ccc;
        padding: 5px;
        min-width: 20px;
      }
      textarea {
        width: 100%;
        height: 150px;
        margin-top: 20px;
        white-space: pre;
      }
      .ctrl-btn {
        width: 20px;
        height: 20px;
        margin: 0 2px;
        padding: 0;
      }
      .control-row td, .control-cell {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>ASCII table manager</h1>
    <p>
      Create/generate or copy-paste an existing ASCII table to edit it easily
    </p>
    <label>Lines: <input type="number" id="rows" min="1" value="3" /></label>
    <label>Columns: <input type="number" id="cols" min="1" value="3" /></label>
    &nbsp;&nbsp;&nbsp;
    <label><input type="checkbox" id="sepAll" checked /> Separate each line</label>
    &nbsp;&nbsp;&nbsp;
    <label><input type="checkbox" id="jsonMode" /> JSON</label>
    &nbsp;&nbsp;&nbsp;
    <label>
      Font:
      <select id="fontSelect">
        <option value="Consolas, monospace" selected>Consolas</option>
        <option value="'Courier New', Courier, monospace">Courier New</option>
        <option value="'Lucida Console', Monaco, monospace">Lucida Console</option>
        <option value="Monaco, monospace">Monaco</option>
        <option value="Menlo, monospace">Menlo</option>
        <option value="'DejaVu Sans Mono', monospace">DejaVu Sans Mono</option>
        <option value="'Source Code Pro', monospace">Source Code Pro</option>
        <option value="'Fira Code', monospace">Fira Code</option>
        <option value="'Roboto Mono', monospace">Roboto Mono</option>
      </select>
    </label>

    <div id="table-container"></div>
    <textarea id="ascii-output" placeholder="Le tableau ASCII apparaÃ®t ici..."></textarea>
    <textarea id="json-output" placeholder="JSON export/import..."></textarea>

    <script>
      const emojiRegex = /\p{Extended_Pictographic}/u;
      function stringWidth(str) {
        return [...str].reduce((w, ch) => w + (emojiRegex.test(ch) ? 2 : 1), 0);
      }

      const rowsInput = document.getElementById("rows");
      const colsInput = document.getElementById("cols");
      const sepAllCheckbox = document.getElementById("sepAll");
      const jsonModeCheckbox = document.getElementById("jsonMode");
      const fontSelect = document.getElementById("fontSelect");
      const container = document.getElementById("table-container");
      const asciiOutput = document.getElementById("ascii-output");
      const jsonOutput = document.getElementById("json-output");

      rowsInput.addEventListener("input", generateTable);
      colsInput.addEventListener("input", generateTable);
      sepAllCheckbox.addEventListener("change", updateAscii);
      jsonModeCheckbox.addEventListener("change", () => updateJSON(getData()));
      asciiOutput.addEventListener("input", importAscii);
      jsonOutput.addEventListener("input", importJSON);
      fontSelect.addEventListener("change", () => {
        container.querySelectorAll("table, textarea").forEach(el => el.style.fontFamily = fontSelect.value);
        updateAscii();
      });

      function generateTable() {
        const oldTable = container.querySelector("table");
        let oldData = [];
        if (oldTable)
          oldData = Array.from(oldTable.rows)
            .filter((tr, i) => !tr.classList.contains('control-row'))
            .map(tr => Array.from(tr.cells).slice(1).map(td => td.textContent.trim()));

        const rows = Math.max(1, parseInt(rowsInput.value) || 1);
        const cols = Math.max(1, parseInt(colsInput.value) || 1);
        container.innerHTML = "";
        const table = document.createElement("table");
        table.style.fontFamily = fontSelect.value;

        // Control row for column buttons
        const ctrlRow = document.createElement("tr");
        ctrlRow.classList.add('control-row');
        // empty corner cell
        const corner = document.createElement("td");
        ctrlRow.appendChild(corner);
        for (let j = 0; j < cols; j++) {
          const cell = document.createElement("td");
          cell.classList.add('control-cell');
          const addBtn = document.createElement("button");
          addBtn.textContent = "+";
          addBtn.title = "Add column to the left";
          addBtn.classList.add('ctrl-btn');
          addBtn.addEventListener("click", () => addColumn(j));
          const delBtn = document.createElement("button");
          delBtn.textContent = "-";
          delBtn.title = "Delete this column";
          delBtn.classList.add('ctrl-btn');
          delBtn.addEventListener("click", () => removeColumn(j));
          cell.append(addBtn, delBtn);
          ctrlRow.appendChild(cell);
        }
        table.appendChild(ctrlRow);

        // Data rows with row buttons
        for (let i = 0; i < rows; i++) {
          const tr = document.createElement("tr");
          // Row control cell
          const ctrlCell = document.createElement("td");
          ctrlCell.classList.add('control-cell');
          const addR = document.createElement("button");
          addR.textContent = "+";
          addR.title = "Add row above";
          addR.classList.add('ctrl-btn');
          addR.addEventListener("click", () => addRow(i));
          const delR = document.createElement("button");
          delR.textContent = "-";
          delR.title = "Delete this row";
          delR.classList.add('ctrl-btn');
          delR.addEventListener("click", () => removeRow(i));
          ctrlCell.append(addR, delR);
          tr.appendChild(ctrlCell);

          for (let j = 0; j < cols; j++) {
            const td = document.createElement("td");
            td.contentEditable = true;
            td.addEventListener("input", updateAscii);
            if (oldData[i] && oldData[i][j] !== undefined)
              td.textContent = oldData[i][j];
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
        container.appendChild(table);
        updateAscii();
      }

      function getData() {
        const table = container.querySelector("table");
        if (!table) return [];
        return Array.from(table.rows)
          .filter(tr => !tr.classList.contains('control-row'))
          .map(tr => Array.from(tr.cells).slice(1).map(td => td.textContent.trim()));
      }

      function updateAscii() {
        const data = getData();
        if (!data.length) return;
        const colWidths = data[0].map((_, ci) => Math.max(...data.map(r => stringWidth(r[ci]))) + 2);
        const border = () => "+" + colWidths.map(w => "-".repeat(w)).join("+") + "+\n";
        const rowLine = row => "|" + row.map((cell, j) => {
          const w = stringWidth(cell);
          return " " + cell + " ".repeat(colWidths[j] - w - 1);
        }).join("|") + "|\n";

        let ascii = border() + rowLine(data[0]) + border();
        if (sepAllCheckbox.checked) {
          data.slice(1).forEach(r => ascii += rowLine(r) + border());
        } else {
          data.slice(1).forEach(r => ascii += rowLine(r));
          ascii += border();
        }
        asciiOutput.value = ascii;
        updateJSON(data);
      }

      function updateJSON(data) {
        if (jsonModeCheckbox.checked && data.length > 1) {
          const headers = data[0];
          const objects = data.slice(1).map(row =>
            headers.reduce((o, k, i) => ((o[k] = row[i]), o), {}));
          jsonOutput.value = JSON.stringify(objects, null, 2);
        } else {
          jsonOutput.value = JSON.stringify(data, null, 2);
        }
      }

      function importAscii() {
        const txt = asciiOutput.value.trim();
        const lines = txt.split("\n").filter(l => l);
        if (!lines.length) return;
        const rowLines = lines.filter(l => /^\|.*\|$/.test(l));
        const data = rowLines.map(l =>
          l.slice(1, -1).split("|").map(c => c.trim())
        );
        rowsInput.value = data.length;
        colsInput.value = data[0].length;
        sepAllCheckbox.checked = lines.filter(l => /^\+[\-+]+\+$/.test(l)).length > data.length + 1;
        generateTable();
        const tbl = container.querySelector("table");
        data.forEach((r, i) => r.forEach((c, j) => tbl.rows[i+1].cells[j+1].textContent = c));
        updateAscii();
      }

      function importJSON() {
        try {
          const parsed = JSON.parse(jsonOutput.value);
          let data = [];
          if (Array.isArray(parsed) && parsed.every(r => Array.isArray(r))) {
            data = parsed;
          } else if (Array.isArray(parsed) && parsed.every(o => o && typeof o === "object")) {
            const headers = Array.from(new Set(parsed.flatMap(o => Object.keys(o))));
            data = [headers].concat(parsed.map(o => headers.map(h => o[h] || "")));
          } else return;
          rowsInput.value = data.length;
          colsInput.value = data[0].length;
          generateTable();
          const tbl = container.querySelector("table");
          data.forEach((r, i) => r.forEach((c, j) => tbl.rows[i+1].cells[j+1].textContent = c));
          updateAscii();
        } catch (e) {
          // JSON invalide
        }
      }

      // Row/Column manipulation functions
      function addColumn(index) {
        const table = container.querySelector("table");
        if (!table) return;
        const dataRows = Array.from(table.rows).filter(r => !r.classList.contains('control-row'));
        dataRows.forEach(tr => {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.addEventListener('input', updateAscii);
          tr.insertBefore(td, tr.cells[index+1]);
        });
        // Update controls row
        const ctrlRow = table.querySelector('.control-row');
        const cell = document.createElement('td');
        cell.classList.add('control-cell');
        const addBtn = document.createElement("button");
        addBtn.textContent = "+";
        addBtn.classList.add('ctrl-btn');
        addBtn.addEventListener("click", () => addColumn(index));
        const delBtn = document.createElement("button");
        delBtn.textContent = "-";
        delBtn.classList.add('ctrl-btn');
        delBtn.addEventListener("click", () => removeColumn(index));
        cell.append(addBtn, delBtn);
        ctrlRow.insertBefore(cell, ctrlRow.cells[index+1]);
        colsInput.value = parseInt(colsInput.value) + 1;
        updateAscii();
      }

      function removeColumn(index) {
        const table = container.querySelector("table");
        if (!table) return;
        const cols = parseInt(colsInput.value);
        if (cols < 2) return; // at least one column
        Array.from(table.rows).forEach(tr => {
          tr.removeChild(tr.cells[index+1]);
        });
        colsInput.value = cols - 1;
        updateAscii();
      }

      function addRow(index) {
        const table = container.querySelector("table");
        if (!table) return;
        const cols = parseInt(colsInput.value);
        const tr = document.createElement('tr');
        const ctrlCell = document.createElement('td');
        ctrlCell.classList.add('control-cell');
        const addBtn = document.createElement("button");
        addBtn.textContent = "+";
        addBtn.classList.add('ctrl-btn');
        addBtn.addEventListener("click", () => addRow(index));
        const delBtn = document.createElement("button");
        delBtn.textContent = "-";
        delBtn.classList.add('ctrl-btn');
        delBtn.addEventListener("click", () => removeRow(index));
        ctrlCell.append(addBtn, delBtn);
        tr.appendChild(ctrlCell);
        for (let j = 0; j < cols; j++) {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.addEventListener('input', updateAscii);
          tr.appendChild(td);
        }
        table.insertBefore(tr, table.rows[index+1]);
        rowsInput.value = parseInt(rowsInput.value) + 1;
        updateAscii();
      }

      function removeRow(index) {
        const table = container.querySelector("table");
        if (!table) return;
        const rows = parseInt(rowsInput.value);
        if (rows < 2) return; // at least one row
        table.deleteRow(index+1);
        rowsInput.value = rows - 1;
        updateAscii();
      }

      // Initial render
      generateTable();
    </script>
  </body>
</html>
